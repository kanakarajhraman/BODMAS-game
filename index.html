<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Quest - Order of Operations</title>
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --sky-300: #7dd3fc;
            --sky-400: #38bdf8;
            --green-200: #bbf7d0;
            --green-400: #4ade80;
            --green-500: #22c55e;
            --green-600: #16a34a;
            --stone-100: #f5f5f4;
            --stone-200: #e7e5e4;
            --stone-300: #d6d3d1;
            --stone-800: #292524;
            --stone-900: #1c1917;
            --yellow-300: #fde047;
            --yellow-400: #facc15;
            --orange-500: #f97316;
            --red-ink: #ff0000;
            --blue-500: #3b82f6;
            --red-500: #ef4444;
            --blue-700: #1d4ed8;
            --purple-600: #9333ea;
            --cyan-500: #06b6d4;
            --cyan-600: #0891b2;
            --white: #ffffff;
            --magenta: #ff00ff;
        }

        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        body {
            margin: 0;
            padding: 0;
            font-family: 'VT323', 'Courier New', monospace;
            background-color: var(--stone-900); 
            color: var(--stone-900);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            overflow: hidden;
            font-size: 1.6rem; 
        }

        * { box-sizing: border-box; }

        /* --- FIXED 3:4 RATIO CONTAINER (Expanded slightly) --- */
        #app {
            width: 95vw;
            max-width: 700px; /* Expanded Width from 600px */
            height: calc(min(95vw, 700px) * 4 / 3); 
            max-height: 98vh;
            background-color: var(--sky-300);
            border: 8px solid var(--stone-800);
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden; /* Scroll handled internally */
            border-radius: 12px;
        }

        .scroll-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .pixel-card { 
            box-shadow: 8px 8px 0px 0px rgba(0,0,0,0.4); 
            border: 5px solid var(--stone-800); 
            background: white;
        }

        /* --- ANIMATIONS --- */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }
        @keyframes slash { 0% { opacity: 0; transform: rotate(-45deg) scale(0); } 50% { opacity: 1; transform: rotate(-45deg) scale(1.2); } 100% { opacity: 0; transform: rotate(-45deg) scale(1.5); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } }
        @keyframes screenPulse { 0% { background-color: var(--sky-300); } 50% { background-color: white; } 100% { background-color: var(--sky-300); } }

        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-blink { animation: blink 4s infinite; }
        .animate-damage { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .pulse-screen { animation: screenPulse 0.3s ease-out; }

        /* --- BUTTONS --- */
        .btn {
            cursor: pointer;
            border: 5px solid var(--stone-800);
            font-family: inherit;
            transition: all 0.1s;
            background: white;
            box-shadow: 6px 6px 0px var(--stone-800);
            font-weight: bold;
        }
        .btn:active { transform: translate(3px, 3px); box-shadow: 0px 0px 0px; }

        .btn-level {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            margin-bottom: 1.25rem;
            color: white;
            font-size: 2rem;
            text-shadow: 2px 2px 0 black;
        }
        .lvl-1 { background-color: var(--green-500); }
        .lvl-2 { background-color: var(--blue-500); }
        .lvl-3 { background-color: var(--orange-500); }
        .lvl-4 { background-color: var(--purple-600); }
        .lvl-5 { background-color: var(--red-500); }

        .token-btn {
            padding: 1rem 1.5rem;
            font-size: 2.5rem;
            border-radius: 12px;
            margin: 0.3rem;
        }
        .token-btn.num { background-color: var(--cyan-500); color: white; border-color: var(--cyan-600); }
        .token-btn.op { background-color: var(--orange-500); color: white; border-color: var(--stone-800); }
        .token-btn.selected-num, .token-btn.selected-op { 
            background-color: var(--yellow-300); 
            color: var(--stone-900); 
            transform: scale(1.1); 
            border-color: var(--stone-900); 
        }

        /* --- ARENA --- */
        .arena {
            height: 18rem;
            min-height: 18rem;
            border-bottom: 6px solid var(--stone-800);
            background-color: var(--sky-400);
            position: relative;
            overflow: hidden;
        }
        .ground {
            position: absolute;
            bottom: 0; width: 100%; height: 3.5rem;
            background-color: var(--green-600);
            border-top: 5px solid var(--stone-800);
        }

        .hero { position: absolute; bottom: 3.5rem; left: 15%; transition: all 0.3s; z-index: 5; }
        .monster { position: absolute; bottom: 3.5rem; right: 15%; transition: all 0.3s; z-index: 5; }
        .hero-body { width: 4.5rem; height: 5.5rem; background: var(--cyan-600); border: 4px solid black; position: relative; }
        .hero-head { width: 3rem; height: 3rem; background: #e0aa89; border: 4px solid black; position: absolute; top: -2.8rem; left: 0.7rem; }
        .monster-body { width: 6rem; height: 8rem; background: var(--magenta); border: 4px solid black; position: relative; }
        
        .character-eye { width: 9px; height: 9px; background: black; position: absolute; top: 10px; border-radius: 50%; }

        .hero.attack { transform: translateX(150px); }
        .slash-effect {
            position: absolute; top: 30%; right: 20%;
            width: 80px; height: 25px; background: white;
            animation: slash 0.3s forwards; pointer-events: none;
        }

        .bar-container { width: 11rem; height: 1.8rem; background: var(--stone-300); border: 4px solid black; position: relative; }
        .bar-fill { height: 100%; transition: width 0.4s ease; }

        .game-input {
            width: 9rem; font-size: 3rem; text-align: center; border: 6px solid black; font-family: inherit; font-weight: bold;
        }

        .working-line {
            font-size: 2.2rem;
            margin: 0.5rem 0;
            display: block;
            letter-spacing: 1px;
            white-space: nowrap;
        }
        .highlight-part {
            background-color: var(--yellow-300);
            border: 2px solid var(--stone-800);
            padding: 0 4px;
            border-radius: 4px;
        }
    </style>
</head>
<body id="body">
    
    <div id="app"></div>

    <script>
        const LEVELS = [
          { id: 1, name: "The Grasslands", desc: "Addition & Subtraction", rules: ['+', '-'], brackets: false, length: 4 },
          { id: 2, name: "The Sandy Dunes", desc: "Multiplication & Division", rules: ['*', '/'], brackets: false, length: 4 },
          { id: 3, name: "The Stone Keep", desc: "Mixed Operations", rules: ['+', '-', '*', '/'], brackets: false, length: 4 },
          { id: 4, name: "The Nether Fortress", desc: "Brackets & Mixed", rules: ['+', '-', '*', '/'], brackets: true, length: 4 },
          { id: 5, name: "The End Dimension", desc: "Expert Mode", rules: ['+', '-', '*', '/'], brackets: true, length: 5 },
        ];

        const state = {
            screen: 'menu',
            unlockedLevels: [1, 2, 3, 4, 5], 
            currentLevel: 1,
            tokens: [],
            history: [], 
            monsterHP: 0,
            questionCount: 1,
            gameState: 'loading',
            selectedStep: null,
            selectedIndices: [],
            inputValue: '',
            feedback: '',
            shake: false,
            heroAction: 'idle',
            isMusicOn: false
        };

        const audioCtxRef = { current: null };
        let musicInterval = null;

        const ICONS = {
            chevron: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg>`,
            speaker: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>`,
            speakerOff: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>`,
        };

        const safeEval = (a, op, b) => {
            if (op === '+') return a + b;
            if (op === '-') return a - b;
            if (op === '*') return a * b;
            if (op === '/') return a / b;
            return 0;
        };

        const generateEquation = (levelId) => {
            const level = LEVELS.find(l => l.id === levelId);
            const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            let attempts = 0;
            while (attempts < 3000) {
                attempts++;
                let nums = Array.from({ length: level.length }, () => getRandomInt(1, 15));
                let ops = Array.from({ length: level.length - 1 }, () => level.rules[getRandomInt(0, level.rules.length - 1)]);
                let tokens = [];
                if (!level.brackets) {
                    for (let i = 0; i < nums.length; i++) {
                        tokens.push({ type: 'num', value: nums[i], id: `n-${Math.random()}` });
                        if (i < ops.length) tokens.push({ type: 'op', value: ops[i], id: `o-${Math.random()}` });
                    }
                } else {
                    const pattern = getRandomInt(0, 3);
                    const tNum = (i) => ({ type: 'num', value: nums[i], id: `n-${Math.random()}` });
                    const tOp = (i) => ({ type: 'op', value: ops[i], id: `o-${Math.random()}` });
                    const tBra = (v) => ({ type: 'bracket', value: v, id: `b-${Math.random()}` });
                    if (level.length === 4) {
                        if (pattern === 0) tokens = [tBra('('), tNum(0), tOp(0), tNum(1), tBra(')'), tOp(1), tNum(2), tOp(2), tNum(3)];
                        else if (pattern === 1) tokens = [tNum(0), tOp(0), tBra('('), tNum(1), tOp(1), tNum(2), tBra(')'), tOp(2), tNum(3)];
                        else if (pattern === 2) tokens = [tNum(0), tOp(0), tNum(1), tOp(1), tBra('('), tNum(2), tOp(2), tNum(3), tBra(')')];
                        else tokens = [tBra('('), tNum(0), tOp(0), tNum(1), tBra(')'), tOp(1), tBra('('), tNum(2), tOp(2), tNum(3), tBra(')')];
                    } else {
                        tokens = [tNum(0), tOp(0), tBra('('), tNum(1), tOp(1), tNum(2), tBra(')'), tOp(2), tNum(3), tOp(3), tNum(4)];
                    }
                }
                if (isValidEquation(tokens)) return tokens;
            }
        };

        const isValidEquation = (initialTokens) => {
            let tokens = JSON.parse(JSON.stringify(initialTokens));
            while (tokens.length > 1) {
                const moves = getValidMoves(tokens);
                if (moves.length === 0) return false;
                const move = moves[0];
                const val = safeEval(move.left.value, move.op.value, move.right.value);
                if (move.op.value === '/' && move.left.value % move.right.value !== 0) return false;
                if (move.op.value === '-' && val <= 0) return false;
                if (!Number.isInteger(val) || val <= 0 || val > 200) return false;
                const newTokens = [];
                for (let i = 0; i < tokens.length; i++) {
                    if (tokens[i].id === move.left.id) {
                        newTokens.push({ type: 'num', value: val, id: `sim-${Math.random()}` });
                        i += 2;
                    } else { newTokens.push(tokens[i]); }
                }
                tokens = cleanBrackets(newTokens);
            }
            return true;
        };

        const cleanBrackets = (tokens) => {
            let current = [...tokens];
            let changed = true;
            while (changed) {
                changed = false;
                const next = [];
                for (let i = 0; i < current.length; i++) {
                    if (current[i]?.value === '(' && current[i+1]?.type === 'num' && current[i+2]?.value === ')') {
                        next.push(current[i+1]); i += 2; changed = true;
                    } else { next.push(current[i]); }
                }
                current = next;
            }
            return current;
        };

        const getValidMoves = (tokens) => {
            let deepestStart = -1, deepestEnd = -1, maxDepth = 0, currentDepth = 0;
            for (let i = 0; i < tokens.length; i++) {
                if (tokens[i].value === '(') {
                    currentDepth++;
                    if (currentDepth > maxDepth) { maxDepth = currentDepth; deepestStart = i; }
                    else deepestStart = i;
                } else if (tokens[i].value === ')') {
                    if (deepestEnd === -1 && currentDepth === maxDepth) deepestEnd = i;
                    currentDepth--;
                }
            }
            let start = 0, end = tokens.length;
            if (deepestStart !== -1 && deepestEnd !== -1) { start = deepestStart + 1; end = deepestEnd; }
            let movesDM = [];
            for (let i = start; i < end; i++) {
                if (tokens[i].type === 'op' && (tokens[i].value === '*' || tokens[i].value === '/')) {
                    movesDM.push({ index: i, op: tokens[i], left: tokens[i-1], right: tokens[i+1] });
                }
            }
            if (movesDM.length > 0) return [movesDM[0]];
            let movesAS = [];
            for (let i = start; i < end; i++) {
                if (tokens[i].type === 'op' && (tokens[i].value === '+' || tokens[i].value === '-')) {
                    movesAS.push({ index: i, op: tokens[i], left: tokens[i-1], right: tokens[i+1] });
                }
            }
            return movesAS.length > 0 ? [movesAS[0]] : [];
        };

        const initAudio = () => {
            if (!audioCtxRef.current) audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume();
            return audioCtxRef.current;
        };

        const playTone = (type, freq, start, dur, vol = 0.1) => {
            const ctx = initAudio();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, ctx.currentTime + start);
            gain.gain.setValueAtTime(vol, ctx.currentTime + start);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + start + dur);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(ctx.currentTime + start); osc.stop(ctx.currentTime + start + dur);
        };

        const playMusic = () => {
            if (musicInterval) clearInterval(musicInterval);
            if (!state.isMusicOn) return;
            const melody = [261, 329, 392, 523];
            let note = 0;
            musicInterval = setInterval(() => {
                playTone('triangle', melody[note % 4], 0, 0.2, 0.01);
                note++;
            }, 350);
        };

        const stopMusic = () => { if (musicInterval) { clearInterval(musicInterval); musicInterval = null; } };

        const soundEffects = {
            wrong: () => playTone('sawtooth', 100, 0, 0.3, 0.1),
            correct: () => playTone('sine', 600, 0, 0.4, 0.1),
            strike: () => playTone('square', 150, 0, 0.2, 0.1),
        };

        function render() { if (state.screen === 'menu') renderMenu(); else renderGame(); }

        function renderMenu() {
            const levelsHtml = LEVELS.map((lvl) => `
                <button class="btn btn-level lvl-${lvl.id}" onclick="startGame(${lvl.id})">
                    <div class="flex items-center gap-6">
                        <div class="pixel-card" style="width: 4rem; height: 4rem; display: flex; align-items: center; justify-content:center; background: white; color: black; font-size: 2.2rem;">${lvl.id}</div>
                        <div style="text-align: left;">
                            <h3 style="margin:0; font-size: 1.8rem;">${lvl.name}</h3>
                            <p style="margin:0; font-size: 1.1rem; opacity: 0.9;">${lvl.desc}</p>
                        </div>
                    </div>
                    <div>${ICONS.chevron}</div>
                </button>
            `).join('');

            app.innerHTML = `
                <div class="scroll-container">
                    <div class="pixel-card p-6 mb-8 text-center w-full" style="background: linear-gradient(45deg, var(--green-200), var(--white));">
                        <h1 style="font-size: 3.5rem; color: var(--green-600); margin:0; text-shadow: 2px 2px 0 white;">MATH QUEST</h1>
                        <p style="font-size: 1.5rem; color: var(--stone-600); font-weight: bold;">Follow Order of Operations to Defeat the Monster!</p>
                    </div>
                    <div class="flex flex-col w-full">${levelsHtml}</div>
                </div>
            `;
        }

        function renderGame() {
            const getDisplayOp = (op) => op === '*' ? 'ร' : op === '/' ? 'รท' : op;

            let headerHtml = `
                <div class="flex justify-between items-center p-4 pixel-card" style="background: rgba(255,255,255,0.9); border-bottom-width: 6px; border-radius:0; z-index: 20;">
                    <button onclick="toggleMusic()" class="btn" style="padding: 0.5rem; width: 3.5rem; height: 3.5rem; display:flex; align-items:center; justify-content:center;">
                        ${state.isMusicOn ? ICONS.speaker : ICONS.speakerOff}
                    </button>
                    
                    <div class="flex flex-col items-center">
                        <div style="font-weight:bold; font-size: 1.5rem;">LVL ${state.currentLevel}</div>
                        <div style="font-weight:bold; font-size: 1.2rem; color: var(--stone-500);">Q:${state.questionCount}/10</div>
                    </div>

                    <button onclick="exitGame()" class="btn" style="padding: 0.4rem 1.2rem; font-size: 1.4rem; height: 3.5rem; background: var(--red-500); color:white;">
                        EXIT
                    </button>
                </div>
            `;

            let arenaHtml = `
                <div class="arena">
                    <div class="ground"></div>
                    <div class="hero animate-float ${state.heroAction === 'attack' ? 'attack' : ''}">
                        <div class="hero-head">
                            <div class="character-eye animate-blink" style="left:7px;"></div>
                            <div class="character-eye animate-blink" style="right:12px;"></div>
                        </div>
                        <div class="hero-body"></div>
                    </div>
                    <div class="monster animate-float ${state.shake ? 'animate-damage' : ''}">
                        <div class="monster-body">
                            <div class="character-eye animate-blink" style="left:12px;"></div>
                            <div class="character-eye animate-blink" style="right:12px;"></div>
                        </div>
                    </div>
                    ${state.heroAction === 'attack' ? `<div class="slash-effect"></div>` : ''}
                    <div style="position: absolute; top: 15px; left: 70px;">
                        <div class="bar-container"><div class="bar-fill" style="background: var(--green-500); width: 100%;"></div></div>
                    </div>
                    <div style="position: absolute; top: 15px; right: 70px;">
                        <div class="bar-container"><div class="bar-fill" style="background: var(--red-500); width: ${((20 - state.monsterHP)/20)*100}%;"></div></div>
                    </div>
                </div>
            `;

            let contentHtml = '';
            if (state.gameState === 'delay') {
                const lines = state.history.map((h, i) => {
                    const lineContent = h.snapshot.map(t => {
                        const isPart = h.highlightIds && h.highlightIds.includes(t.id);
                        const displayVal = t.type === 'op' ? getDisplayOp(t.value) : t.value;
                        return isPart ? `<span class="highlight-part">${displayVal}</span>` : displayVal;
                    }).join(' ');
                    return `<span class="working-line">${i === 0 ? '' : '= '}${lineContent}</span>`;
                });
                lines.push(`<span class="working-line" style="color: var(--green-600); font-weight: bold;">= ${state.tokens[0].value}</span>`);

                contentHtml = `
                    <div class="text-center">
                        <h2 style="font-size: 2.2rem; color: var(--green-600); margin-top:0;">CORRECT!</h2>
                        <div class="pixel-card p-4 mb-6" style="background: var(--stone-100); text-align: left; display: inline-block; min-width: 80%; border-color: var(--green-600);">
                            ${lines.join('')}
                        </div>
                        <br>
                        <button onclick="proceedToNextQuestion()" class="btn" style="padding: 1rem 2.5rem; background: var(--green-500); color: white; font-size: 2rem;">NEXT QUESTION</button>
                    </div>
                `;
            } else if (state.gameState === 'victory' || state.gameState === 'gameover') {
                contentHtml = `
                    <div class="text-center py-6 pixel-card" style="background: ${state.gameState === 'victory' ? 'var(--yellow-100)' : 'var(--red-100)'}">
                        <h2 style="font-size: 3.5rem; margin:0;">${state.gameState === 'victory' ? 'VICTORY!' : 'DEFEAT!'}</h2>
                        <p style="font-size: 1.8rem;">Final Score: ${state.monsterHP}</p>
                        <button onclick="exitGame()" class="btn" style="padding: 1rem 2.5rem; font-size: 1.8rem; background: white;">RETURN TO MENU</button>
                    </div>
                `;
            } else {
                const isError = state.feedback.toLowerCase().includes('mistake') || 
                                state.feedback.toLowerCase().includes('wrong') || 
                                state.feedback.toLowerCase().includes('error');
                const feedbackColor = isError ? 'var(--red-ink)' : 'var(--blue-700)';

                let tokensHtml = state.tokens.map((t, idx) => {
                    if (t.type === 'bracket') return `<div style="font-size: 3.5rem; color: var(--orange-500); padding: 0 0.5rem; font-weight: bold;">${t.value}</div>`;
                    return `<button onclick="handleTokenClick(${idx})" class="btn token-btn ${t.type} ${state.selectedIndices.includes(idx) ? 'selected-' + t.type : ''}">${t.type === 'op' ? getDisplayOp(t.value) : t.value}</button>`;
                }).join('');

                contentHtml = `
                    <div class="mb-4 p-4 text-center pixel-card" style="font-size: 1.6rem; border-color: ${feedbackColor}; color: ${feedbackColor};">${state.feedback}</div>
                    <div class="flex items-center justify-center flex-wrap gap-1 p-4 pixel-card" style="background: var(--stone-100);">${tokensHtml}</div>
                    ${state.selectedStep ? `
                        <div class="pixel-card p-4 mt-6 text-center" style="background: var(--stone-800); color: white;">
                            <div class="mb-2" style="font-size: 2rem; color: var(--yellow-300);">${state.selectedStep.left.value} ${getDisplayOp(state.selectedStep.op.value)} ${state.selectedStep.right.value} = ?</div>
                            <form onsubmit="handleInputSubmit(event)" class="flex justify-center gap-4">
                                <input id="gameInput" type="number" class="game-input" oninput="state.inputValue = this.value">
                                <button type="submit" class="btn" style="background: var(--green-500); color: white; font-size: 1.6rem; padding: 0 1.5rem;">STRIKE</button>
                                <button type="button" onclick="cancelStep()" class="btn" style="background: var(--red-500); color: white; font-size: 1.6rem; padding: 0 1rem;">X</button>
                            </form>
                        </div>
                    ` : ''}
                `;
            }

            app.innerHTML = `
                ${headerHtml}
                ${arenaHtml}
                <div class="scroll-container">
                    ${contentHtml}
                </div>
            `;
            if (state.selectedStep) document.getElementById('gameInput').focus();
        }

        function startGame(id) { 
            state.currentLevel = id; state.screen = 'game'; state.monsterHP = 0; state.questionCount = 1; 
            loadNewQuestion(); render(); 
        }

        function exitGame() { 
            state.screen = 'menu'; // RETURNS TO MAIN PAGE
            stopMusic(); 
            render(); 
        }

        function loadNewQuestion() { 
            state.tokens = generateEquation(state.currentLevel); 
            state.history = [{ snapshot: JSON.parse(JSON.stringify(state.tokens)) }]; 
            state.gameState = 'input'; 
            state.feedback = "What is the next operation?"; state.selectedIndices = []; state.selectedStep = null; state.inputValue = '';
        }

        function handleTokenClick(idx) {
            if (state.gameState !== 'input') return;
            if (state.selectedIndices.includes(idx)) state.selectedIndices = state.selectedIndices.filter(i => i !== idx);
            else if (state.selectedIndices.length < 3) state.selectedIndices.push(idx);
            if (state.selectedIndices.length === 3) {
                const sorted = [...state.selectedIndices].sort((a,b)=>a-b);
                const [t1, t2, t3] = [state.tokens[sorted[0]], state.tokens[sorted[1]], state.tokens[sorted[2]]];
                if (sorted[1] === sorted[0]+1 && sorted[2] === sorted[1]+1 && t1.type === 'num' && t2.type === 'op' && t3.type === 'num') {
                    const validMoves = getValidMoves(state.tokens);
                    if (validMoves[0].op.id === t2.id) {
                        state.selectedStep = validMoves[0]; state.selectedIndices = []; state.feedback = "CORRECT! Strike the monster!";
                    } else {
                        state.shake = true; soundEffects.wrong();
                        const hasBra = state.tokens.some(t => t.value === '(');
                        const hasMD = state.tokens.filter(t => t.type === 'op').some(o => o.value === '*' || o.value === '/');
                        if (hasBra) state.feedback = "Mistake: Brackets () first!";
                        else if (hasMD && (t2.value === '+' || t2.value === '-')) state.feedback = "Mistake: Multiply/Divide before Add/Subtract!";
                        else state.feedback = "Mistake: Solve from LEFT to RIGHT!";
                        setTimeout(()=> { state.shake = false; state.selectedIndices = []; render(); }, 1200);
                    }
                } else { state.selectedIndices = []; }
            }
            render();
        }

        function handleInputSubmit(e) {
            e.preventDefault();
            const correctVal = safeEval(state.selectedStep.left.value, state.selectedStep.op.value, state.selectedStep.right.value);
            if (parseInt(state.inputValue) === correctVal) {
                document.getElementById('body').classList.add('pulse-screen');
                state.heroAction = 'attack'; soundEffects.strike();
                
                state.history.push({
                    snapshot: JSON.parse(JSON.stringify(state.tokens)),
                    highlightIds: [state.selectedStep.left.id, state.selectedStep.op.id, state.selectedStep.right.id]
                });

                const newTokens = [];
                for (let i = 0; i < state.tokens.length; i++) {
                    if (state.tokens[i].id === state.selectedStep.left.id) { newTokens.push({ type: 'num', value: correctVal, id: `r-${Math.random()}` }); i += 2; }
                    else newTokens.push(state.tokens[i]);
                }
                state.tokens = cleanBrackets(newTokens); 
                state.selectedStep = null; state.inputValue = '';

                setTimeout(() => {
                    document.getElementById('body').classList.remove('pulse-screen');
                    state.heroAction = 'idle';
                    if (state.tokens.length === 1) { 
                        state.monsterHP += 2; 
                        if (state.questionCount >= 10) state.gameState = state.monsterHP >= 18 ? 'victory' : 'gameover';
                        else state.gameState = 'delay';
                    } else state.feedback = "EXCELLENT! What's next?";
                    render();
                }, 400);
            } else { 
                state.feedback = "Calculation error! Calculate again."; 
                soundEffects.wrong(); state.shake = true; setTimeout(()=> { state.shake = false; render(); }, 500); 
            }
        }

        function proceedToNextQuestion() { state.questionCount++; loadNewQuestion(); render(); }
        function cancelStep() { state.selectedStep = null; state.selectedIndices = []; state.feedback = "What is the next operation?"; render(); }
        function toggleMusic() { state.isMusicOn = !state.isMusicOn; if(state.isMusicOn) playMusic(); else stopMusic(); render(); }

        render();
    </script>
</body>
</html>